---
title: ã€Reactã€‘hook - useLayoutEffect
date: 2025-10-22 19:33:36
categories:
  - React
---

- ç”¨æ³•ä¸ `useEffect` å®Œå…¨ç›¸åŒï¼Œä½†æ‰§è¡Œæ—¶æœºä¸åŒ
- **æ ¸å¿ƒåŒºåˆ«ï¼š** useLayoutEffect åœ¨ DOM å˜æ›´åã€æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰**åŒæ­¥**æ‰§è¡Œï¼Œè€Œ useEffect åœ¨ç»˜åˆ¶ä¹‹å**å¼‚æ­¥**æ‰§è¡Œ

<!--more-->

---

### æ‰§è¡Œæ—¶æœºå¯¹æ¯”

```
æ¸²æŸ“æµç¨‹ï¼š
1. React æ›´æ–° DOM
2. ğŸ”µ useLayoutEffect æ‰§è¡Œï¼ˆåŒæ­¥ï¼Œé˜»å¡æ¸²æŸ“ï¼‰
3. æµè§ˆå™¨ç»˜åˆ¶å±å¹•
4. ğŸŸ¢ useEffect æ‰§è¡Œï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡æ¸²æŸ“ï¼‰
```

| Hook            | æ‰§è¡Œæ—¶æœº           | æ˜¯å¦é˜»å¡æ¸²æŸ“ | ç”¨æˆ·æ˜¯å¦çœ‹åˆ°é—ªçƒ |
| --------------- | ------------------ | ------------ | ---------------- |
| useLayoutEffect | DOM æ›´æ–°åï¼Œç»˜åˆ¶å‰ | âœ… é˜»å¡      | âŒ ä¸ä¼š          |
| useEffect       | DOM æ›´æ–°åï¼Œç»˜åˆ¶å | âŒ ä¸é˜»å¡    | âœ… å¯èƒ½ä¼š        |

---

### åœºæ™¯ä»£ç ç¤ºä¾‹

- ã€åœºæ™¯ 1ã€‘æµ‹é‡ DOM å°ºå¯¸(å¸¸ç”¨):

  - éœ€è¦åœ¨æ¸²æŸ“å‰è·å– DOM å°ºå¯¸ï¼Œé¿å…é—ªçƒ

    **âŒ ä½¿ç”¨ useEffect - ä¼šé—ªçƒ**

    ```ts
    import { useState, useEffect, useRef } from "react";

    const Tooltip = ({ text, children }) => {
      const [tooltipWidth, setTooltipWidth] = useState(0);
      const tooltipRef = useRef();

      // âŒ useEffectï¼šç»˜åˆ¶åæ‰§è¡Œï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä½ç½®è·³åŠ¨
      useEffect(() => {
        const width = tooltipRef.current.offsetWidth;
        setTooltipWidth(width);
      }, []);

      return (
        <div>
          {children}
          <div
            ref={tooltipRef}
            style={{
              position: "absolute",
              left: tooltipWidth > 100 ? "-50px" : "0px", // ä½ç½®ä¼šè·³åŠ¨
            }}
          >
            {text}
          </div>
        </div>
      );
    };
    ```

    **âœ… ä½¿ç”¨ useLayoutEffect - ä¸ä¼šé—ªçƒ**

    ```ts
    import { useState, useLayoutEffect, useRef } from "react";

    const Tooltip = ({ text, children }) => {
      const [tooltipWidth, setTooltipWidth] = useState(0);
      const tooltipRef = useRef();

      // âœ… useLayoutEffectï¼šç»˜åˆ¶å‰æ‰§è¡Œï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯æœ€ç»ˆä½ç½®
      useLayoutEffect(() => {
        const width = tooltipRef.current.offsetWidth;
        setTooltipWidth(width);
      }, []);

      return (
        <div>
          {children}
          <div
            ref={tooltipRef}
            style={{
              position: "absolute",
              left: tooltipWidth > 100 ? "-50px" : "0px", // ä½ç½®ä¸ä¼šè·³åŠ¨
            }}
          >
            {text}
          </div>
        </div>
      );
    };
    ```

- ã€åœºæ™¯ 2ã€‘æ“ä½œ DOM é¿å…é—ªçƒ(å¸¸ç”¨):

  - éœ€è¦åœ¨æ¸²æŸ“å‰ä¿®æ”¹ DOMï¼Œé¿å…è§†è§‰é—ªçƒ

    ```ts
    import { useLayoutEffect, useRef } from "react";

    const ScrollToTop = ({ children }) => {
      const containerRef = useRef();

      // âœ… useLayoutEffectï¼šåœ¨ç»˜åˆ¶å‰æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç”¨æˆ·çœ‹ä¸åˆ°æ»šåŠ¨è¿‡ç¨‹
      useLayoutEffect(() => {
        containerRef.current.scrollTop = 0;
      }, [children]); // children å˜åŒ–æ—¶æ»šåŠ¨åˆ°é¡¶éƒ¨

      return (
        <div ref={containerRef} style={{ height: "500px", overflow: "auto" }}>
          {children}
        </div>
      );
    };
    ```

    **å¯¹æ¯” useEffectï¼š**

    ```ts
    // âŒ useEffectï¼šç”¨æˆ·ä¼šçœ‹åˆ°å…ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå†è·³å›é¡¶éƒ¨çš„é—ªçƒ
    useEffect(() => {
      containerRef.current.scrollTop = 0;
    }, [children]);
    ```

- ã€åœºæ™¯ 3ã€‘åŒæ­¥åŠ¨ç”»çŠ¶æ€(å¸¸ç”¨):

  - éœ€è¦åœ¨æ¸²æŸ“å‰åŒæ­¥åŠ¨ç”»ç›¸å…³çš„çŠ¶æ€

    ```ts
    import { useState, useLayoutEffect, useRef } from "react";

    const AnimatedBox = ({ isOpen }) => {
      const [height, setHeight] = useState(0);
      const contentRef = useRef();

      // âœ… useLayoutEffectï¼šåœ¨ç»˜åˆ¶å‰è®¡ç®—é«˜åº¦ï¼ŒåŠ¨ç”»æµç•…
      useLayoutEffect(() => {
        if (isOpen) {
          const contentHeight = contentRef.current.scrollHeight;
          setHeight(contentHeight);
        } else {
          setHeight(0);
        }
      }, [isOpen]);

      return (
        <div
          style={{
            height: `${height}px`,
            overflow: "hidden",
            transition: "height 0.3s ease",
          }}
        >
          <div ref={contentRef}>
            <p>è¿™æ˜¯ä¸€æ®µå†…å®¹</p>
            <p>å¯ä»¥æŠ˜å å’Œå±•å¼€</p>
          </div>
        </div>
      );
    };
    ```

- ã€åœºæ™¯ 4ã€‘è¯»å–å¸ƒå±€ä¿¡æ¯åæ›´æ–°(å¸¸ç”¨):

  - åŸºäº DOM å¸ƒå±€ä¿¡æ¯æ›´æ–°çŠ¶æ€

    ```ts
    import { useState, useLayoutEffect, useRef } from "react";

    const ResponsiveComponent = () => {
      const [isMobile, setIsMobile] = useState(false);
      const containerRef = useRef();

      // âœ… useLayoutEffectï¼šåœ¨ç»˜åˆ¶å‰åˆ¤æ–­æ˜¯å¦ç§»åŠ¨ç«¯ï¼Œé¿å…å¸ƒå±€è·³åŠ¨
      useLayoutEffect(() => {
        const updateLayout = () => {
          const width = containerRef.current.offsetWidth;
          setIsMobile(width < 768);
        };

        updateLayout();
        window.addEventListener("resize", updateLayout);
        return () => window.removeEventListener("resize", updateLayout);
      }, []);

      return (
        <div ref={containerRef}>
          {isMobile ? <MobileView /> : <DesktopView />}
        </div>
      );
    };
    ```

- ã€åœºæ™¯ 5ã€‘ç¬¬ä¸‰æ–¹åº“éœ€è¦åŒæ­¥åˆå§‹åŒ–(è¿›é˜¶):

  - æŸäº›ç¬¬ä¸‰æ–¹åº“éœ€è¦åœ¨ DOM å®Œå…¨å‡†å¤‡å¥½åç«‹å³åˆå§‹åŒ–

    ```ts
    import { useLayoutEffect, useRef } from "react";
    import Chart from "chart.js"; // å‡è®¾æ˜¯å›¾è¡¨åº“

    const ChartComponent = ({ data }) => {
      const canvasRef = useRef();
      const chartRef = useRef();

      // âœ… useLayoutEffectï¼šç¡®ä¿å›¾è¡¨åœ¨ç»˜åˆ¶å‰å®Œæˆåˆå§‹åŒ–
      useLayoutEffect(() => {
        const ctx = canvasRef.current.getContext("2d");
        chartRef.current = new Chart(ctx, {
          type: "bar",
          data: data,
        });

        return () => {
          chartRef.current.destroy();
        };
      }, [data]);

      return <canvas ref={canvasRef} />;
    };
    ```

---

### useLayoutEffect vs useEffect è¯¦ç»†å¯¹æ¯”

| ç‰¹æ€§         | useLayoutEffect                 | useEffect                        |
| ------------ | ------------------------------- | -------------------------------- |
| æ‰§è¡Œæ—¶æœº     | DOM æ›´æ–°åï¼Œæµè§ˆå™¨ç»˜åˆ¶å‰        | æµè§ˆå™¨ç»˜åˆ¶å                     |
| æ˜¯å¦åŒæ­¥     | âœ… åŒæ­¥æ‰§è¡Œ                     | âŒ å¼‚æ­¥æ‰§è¡Œ                      |
| æ˜¯å¦é˜»å¡æ¸²æŸ“ | âœ… é˜»å¡æµè§ˆå™¨ç»˜åˆ¶               | âŒ ä¸é˜»å¡                        |
| ç”¨æˆ·ä½“éªŒ     | æ— é—ªçƒï¼Œä½†å¯èƒ½å¡é¡¿              | å¯èƒ½é—ªçƒï¼Œä½†ä¸å¡é¡¿               |
| é€‚ç”¨åœºæ™¯     | éœ€è¦è¯»å–å¸ƒå±€ã€ä¿®æ”¹ DOM é¿å…é—ªçƒ | å¤§éƒ¨åˆ†å‰¯ä½œç”¨ï¼ˆç½‘ç»œè¯·æ±‚ã€è®¢é˜…ç­‰ï¼‰ |
| æ€§èƒ½         | è¾ƒå·®ï¼ˆé˜»å¡æ¸²æŸ“ï¼‰                | è¾ƒå¥½ï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰               |
| æ¨èä½¿ç”¨é¢‘ç‡ | å°‘ç”¨                            | å¸¸ç”¨                             |
| SSR å…¼å®¹æ€§   | âš ï¸ æœåŠ¡ç«¯ä¼šè­¦å‘Š                 | âœ… æ— é—®é¢˜                        |

---

### ä½•æ—¶ä½¿ç”¨ useLayoutEffect

| æƒ…å†µ                   | è¯´æ˜                                | ç¤ºä¾‹                     |
| ---------------------- | ----------------------------------- | ------------------------ |
| éœ€è¦æµ‹é‡ DOM å°ºå¯¸      | è·å–å…ƒç´ å®½é«˜ã€ä½ç½®ç­‰å¸ƒå±€ä¿¡æ¯        | Tooltip å®šä½ã€å“åº”å¼å¸ƒå±€ |
| éœ€è¦åœ¨æ¸²æŸ“å‰ä¿®æ”¹ DOM   | é¿å…ç”¨æˆ·çœ‹åˆ°ä¸­é—´çŠ¶æ€                | æ»šåŠ¨ä½ç½®ã€å…ƒç´ æ ·å¼       |
| éœ€è¦åŒæ­¥è¯»å–å¸ƒå±€åæ›´æ–° | åŸºäºå¸ƒå±€ä¿¡æ¯ç«‹å³æ›´æ–°çŠ¶æ€            | è‡ªé€‚åº”ç»„ä»¶ã€æŠ˜å é¢æ¿     |
| éœ€è¦é¿å…è§†è§‰é—ªçƒ       | DOM æ›´æ–°åç«‹å³æ‰§è¡Œï¼Œç”¨æˆ·çœ‹ä¸åˆ°å˜åŒ–  | åŠ¨ç”»åˆå§‹åŒ–ã€ä½ç½®è°ƒæ•´     |
| ç¬¬ä¸‰æ–¹åº“éœ€è¦åŒæ­¥åˆå§‹åŒ– | æŸäº›åº“å¿…é¡»åœ¨ DOM å‡†å¤‡å¥½åç«‹å³åˆå§‹åŒ– | å›¾è¡¨åº“ã€ç¼–è¾‘å™¨           |

---

### æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹

```ts
import { useState, useEffect, useLayoutEffect } from "react";

const PerformanceTest = () => {
  const [count, setCount] = useState(0);

  // useEffectï¼šä¸é˜»å¡æ¸²æŸ“ï¼Œç”¨æˆ·ä½“éªŒæ›´æµç•…
  useEffect(() => {
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    const start = Date.now();
    while (Date.now() - start < 100) {} // é˜»å¡ 100ms
    console.log("useEffect æ‰§è¡Œå®Œæ¯•");
  }, [count]);

  // useLayoutEffectï¼šé˜»å¡æ¸²æŸ“ï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰å¡é¡¿
  useLayoutEffect(() => {
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    const start = Date.now();
    while (Date.now() - start < 100) {} // é˜»å¡ 100ms
    console.log("useLayoutEffect æ‰§è¡Œå®Œæ¯•");
  }, [count]);

  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>+1</button>
    </div>
  );
};

// ç»“æœï¼š
// - useEffectï¼šç‚¹å‡»æŒ‰é’®åï¼Œcount ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œ100ms åæ‰“å°æ—¥å¿—ï¼ˆæµç•…ï¼‰
// - useLayoutEffectï¼šç‚¹å‡»æŒ‰é’®åï¼Œç­‰å¾… 100msï¼Œç„¶å count æ‰æ˜¾ç¤ºï¼ˆå¡é¡¿ï¼‰
```

---

### æ³¨æ„äº‹é¡¹

- âš ï¸ **ä¼˜å…ˆä½¿ç”¨ useEffect**

  ```ts
  // é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ useEffect
  // åªæœ‰åœ¨ç¡®å®éœ€è¦åŒæ­¥æ‰§è¡Œæ—¶ï¼Œæ‰ä½¿ç”¨ useLayoutEffect
  ```

- âš ï¸ **æœåŠ¡ç«¯æ¸²æŸ“ (SSR) è­¦å‘Š**

  ```ts
  // useLayoutEffect åœ¨æœåŠ¡ç«¯ä¼šäº§ç”Ÿè­¦å‘Šï¼Œå› ä¸ºæœåŠ¡ç«¯æ²¡æœ‰ DOM
  // å¦‚æœéœ€è¦å…¼å®¹ SSRï¼Œå¯ä»¥è¿™æ ·å¤„ç†ï¼š

  import { useEffect, useLayoutEffect } from "react";

  const useIsomorphicLayoutEffect =
    typeof window !== "undefined" ? useLayoutEffect : useEffect;

  // ä½¿ç”¨
  useIsomorphicLayoutEffect(() => {
    // ä»£ç 
  }, []);
  ```

- âš ï¸ **é¿å…è€—æ—¶æ“ä½œ**

  ```ts
  // âŒ é”™è¯¯ï¼šuseLayoutEffect ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œä¼šé˜»å¡æ¸²æŸ“
  useLayoutEffect(() => {
    // è€—æ—¶è®¡ç®—
    for (let i = 0; i < 1000000; i++) {
      // ...
    }
  }, []);

  // âœ… æ­£ç¡®ï¼šè€—æ—¶æ“ä½œæ”¾åˆ° useEffect
  useEffect(() => {
    // è€—æ—¶è®¡ç®—
    for (let i = 0; i < 1000000; i++) {
      // ...
    }
  }, []);
  ```

- âš ï¸ **ä¸è¦è¿‡åº¦ä¼˜åŒ–**

  ```ts
  // å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä¸ä¼šæ³¨æ„åˆ° useEffect çš„é—ªçƒ
  // åªæœ‰åœ¨ç¡®å®å‡ºç°è§†è§‰é—®é¢˜æ—¶ï¼Œæ‰åˆ‡æ¢åˆ° useLayoutEffect
  ```

- âœ… **æµ‹é‡ DOM æ—¶ä½¿ç”¨**

  ```ts
  // âœ… é€‚åˆä½¿ç”¨ useLayoutEffect çš„å…¸å‹åœºæ™¯
  useLayoutEffect(() => {
    const rect = elementRef.current.getBoundingClientRect();
    setPosition(rect);
  }, []);
  ```

- âœ… **è°ƒè¯•æŠ€å·§**

  ```ts
  // å¦‚æœä¸ç¡®å®šæ˜¯å¦éœ€è¦ useLayoutEffectï¼Œå¯ä»¥å…ˆç”¨ useEffect
  // å¦‚æœå‡ºç°é—ªçƒæˆ–å¸ƒå±€è·³åŠ¨ï¼Œå†æ”¹ä¸º useLayoutEffect

  // è°ƒè¯•æ—¶å¯ä»¥æ‰“å°æ‰§è¡Œé¡ºåº
  useLayoutEffect(() => {
    console.log("useLayoutEffect - åœ¨ç»˜åˆ¶å‰æ‰§è¡Œ");
  });

  useEffect(() => {
    console.log("useEffect - åœ¨ç»˜åˆ¶åæ‰§è¡Œ");
  });
  ```

---

### å¿«é€Ÿå†³ç­–æ ‘

```
éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨ï¼Ÿ
  â†“
æ˜¯å¦æ¶‰åŠ DOM æµ‹é‡æˆ–ä¿®æ”¹ï¼Ÿ
  â†“ å¦ â†’ ä½¿ç”¨ useEffect âœ…
  â†“ æ˜¯
  â†“
ç”¨æˆ·æ˜¯å¦ä¼šçœ‹åˆ°é—ªçƒæˆ–å¸ƒå±€è·³åŠ¨ï¼Ÿ
  â†“ å¦ â†’ ä½¿ç”¨ useEffect âœ…
  â†“ æ˜¯
  â†“
ä½¿ç”¨ useLayoutEffect âœ…
```

---

### æ€»ç»“

| åŸåˆ™                           | è¯´æ˜                           |
| ------------------------------ | ------------------------------ |
| **é»˜è®¤ä½¿ç”¨ useEffect**         | 99% çš„æƒ…å†µéƒ½åº”è¯¥ç”¨ useEffect   |
| **é—ªçƒæ—¶ç”¨ useLayoutEffect**   | åªæœ‰åœ¨å‡ºç°è§†è§‰é—®é¢˜æ—¶æ‰åˆ‡æ¢     |
| **é¿å…è€—æ—¶æ“ä½œ**               | useLayoutEffect ä¼šé˜»å¡æ¸²æŸ“     |
| **æµ‹é‡å¸ƒå±€ç”¨ useLayoutEffect** | è·å–å°ºå¯¸ã€ä½ç½®ç­‰å¸ƒå±€ä¿¡æ¯æ—¶ä½¿ç”¨ |
| **SSR éœ€è¦ç‰¹æ®Šå¤„ç†**           | ä½¿ç”¨ useIsomorphicLayoutEffect |

**è®°ä½ï¼šuseLayoutEffect æ˜¯ useEffect çš„åŒæ­¥ç‰ˆæœ¬ï¼Œç”¨äºéœ€è¦åœ¨æµè§ˆå™¨ç»˜åˆ¶å‰æ‰§è¡Œçš„åœºæ™¯ã€‚**
